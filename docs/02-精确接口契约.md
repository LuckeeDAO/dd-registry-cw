# DD Registry CW 精确接口契约

## 📋 文档信息

- **项目名称**: DD Registry CW (推荐积分合约)
- **版本**: v1.0
- **文档类型**: 精确接口契约
- **标准**: OpenAPI Specification 3.0
- **创建日期**: 2024-01-XX
- **最后更新**: 2024-01-XX

## 🎯 概述

本文档定义了DD Registry CW合约的所有接口，包括请求/响应格式、状态码、错误类型和数据验证规则。作为AI之间、系统与系统之间交互的"法律文书"，确保无缝集成。

## 📡 合约接口规范

### 1. 实例化接口 (InstantiateMsg)

```yaml
openapi: 3.0.0
info:
  title: DD Registry CW Contract API
  version: 1.0.0
  description: DD Registry CW推荐积分合约接口规范

paths:
  /instantiate:
    post:
      summary: 实例化合约
      description: 创建新的DD Registry CW合约实例
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InstantiateMsg'
      responses:
        '200':
          description: 实例化成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstantiateResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    InstantiateMsg:
      type: object
      required:
        - admin
        - config
      properties:
        admin:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          description: 管理员地址
          example: "luckee1abc123..."
        config:
          $ref: '#/components/schemas/ContractConfig'

    ContractConfig:
      type: object
      required:
        - enabled
        - max_referral_depth
        - referral_cooldown
        - max_daily_referrals
        - min_withdrawal_amount
        - emergency_paused
      properties:
        enabled:
          type: boolean
          description: 系统是否启用
          example: true
        max_referral_depth:
          type: integer
          minimum: 1
          maximum: 10
          description: 最大推荐深度
          example: 3
        referral_cooldown:
          type: integer
          minimum: 0
          description: 推荐冷却期（秒）
          example: 3600
        max_daily_referrals:
          type: integer
          minimum: 1
          description: 每日最大推荐数
          example: 10
        min_withdrawal_amount:
          type: string
          pattern: '^[0-9]+$'
          description: 最小提取数量
          example: "1000"
        emergency_paused:
          type: boolean
          description: 是否紧急暂停
          example: false

    InstantiateResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        contract_address:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          example: "luckee1jkl012..."
        config:
          $ref: '#/components/schemas/ContractConfig'
```

### 2. 执行接口 (ExecuteMsg)

```yaml
  /execute:
    post:
      summary: 执行合约操作
      description: 执行推荐积分相关操作
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteMsg'
      responses:
        '200':
          description: 执行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    ExecuteMsg:
      type: object
      oneOf:
        - $ref: '#/components/schemas/RegisterMsg'
        - $ref: '#/components/schemas/AllocateRewardsMsg'
        - $ref: '#/components/schemas/WithdrawPointsMsg'
        - $ref: '#/components/schemas/AdminMsg'

    RegisterMsg:
      type: object
      required:
        - register
      properties:
        register:
          type: object
          properties:
            referrer:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 推荐人地址（可选）
              nullable: true

    AllocateRewardsMsg:
      type: object
      required:
        - allocate_rewards
      properties:
        allocate_rewards:
          type: object
          required:
            - user
            - points
            - reason
          properties:
            user:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 用户地址
            points:
              type: string
              pattern: '^[0-9]+$'
              minimum: "1"
              description: 积分数量
            reason:
              type: string
              enum: ["activity_bonus", "referral_reward", "level_bonus", "special_event"]
              description: 积分原因
            related_user:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 相关用户地址（可选）
              nullable: true
            event_id:
              type: string
              description: 事件ID（可选）
              nullable: true

    WithdrawPointsMsg:
      type: object
      required:
        - withdraw_points
      properties:
        withdraw_points:
          type: object
          required:
            - amount
          properties:
            amount:
              type: string
              pattern: '^[0-9]+$'
              minimum: "1000"
              description: 提取的积分数量

    AdminMsg:
      type: object
      oneOf:
        - $ref: '#/components/schemas/UpdateConfigMsg'
        - $ref: '#/components/schemas/EmergencyPauseMsg'

    UpdateConfigMsg:
      type: object
      required:
        - update_config
      properties:
        update_config:
          type: object
          required:
            - config
          properties:
            config:
              $ref: '#/components/schemas/ContractConfig'

    EmergencyPauseMsg:
      type: object
      required:
        - emergency_pause
      properties:
        emergency_pause:
          type: object
          required:
            - paused
          properties:
            paused:
              type: boolean
              description: 是否暂停

    ExecuteResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        transaction_hash:
          type: string
          description: 交易哈希
          example: "0x1234567890abcdef..."
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
          description: 事件列表
```

### 3. 查询接口 (QueryMsg)

```yaml
  /query:
    post:
      summary: 查询合约状态
      description: 查询推荐积分相关信息
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryMsg'
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/UserInfoResponse'
                  - $ref: '#/components/schemas/ReferralChainResponse'
                  - $ref: '#/components/schemas/PointsLeaderboardResponse'
                  - $ref: '#/components/schemas/ConfigResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    QueryMsg:
      type: object
      oneOf:
        - $ref: '#/components/schemas/UserInfoQuery'
        - $ref: '#/components/schemas/ReferralChainQuery'
        - $ref: '#/components/schemas/PointsLeaderboardQuery'
        - $ref: '#/components/schemas/ConfigQuery'

    UserInfoQuery:
      type: object
      required:
        - get_user_info
      properties:
        get_user_info:
          type: object
          required:
            - user
          properties:
            user:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 用户地址

    ReferralChainQuery:
      type: object
      required:
        - get_referral_chain
      properties:
        get_referral_chain:
          type: object
          required:
            - user
          properties:
            user:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 用户地址
            max_depth:
              type: integer
              minimum: 1
              maximum: 3
              description: 最大查询深度
              default: 3

    PointsLeaderboardQuery:
      type: object
      required:
        - get_points_leaderboard
      properties:
        get_points_leaderboard:
          type: object
          properties:
            limit:
              type: integer
              minimum: 1
              maximum: 100
              description: 返回数量限制
              default: 10
            offset:
              type: integer
              minimum: 0
              description: 偏移量
              default: 0

    ConfigQuery:
      type: object
      required:
        - get_config
      properties:
        get_config:
          type: object
          description: 查询合约配置

    UserInfoResponse:
      type: object
      properties:
        user_info:
          type: object
          properties:
            recommender:
              type: string
              pattern: '^luckee[a-z0-9]{38}$'
              description: 推荐人地址
              nullable: true
            direct_referrals:
              type: array
              items:
                type: string
                pattern: '^luckee[a-z0-9]{38}$'
              description: 直接推荐的下级
            reward_points:
              type: string
              pattern: '^[0-9]+$'
              description: 累积积分
            registered_at:
              type: integer
              description: 注册时间戳
            last_active_at:
              type: integer
              description: 最后活跃时间戳
            user_level:
              type: string
              enum: ["Bronze", "Silver", "Gold", "Platinum"]
              description: 用户等级
            referral_stats:
              type: object
              properties:
                total_referrals:
                  type: integer
                  description: 总推荐数
                active_referrals:
                  type: integer
                  description: 活跃推荐数
                total_points_earned:
                  type: string
                  pattern: '^[0-9]+$'
                  description: 总获得积分
            status:
              type: string
              enum: ["active", "suspended", "banned"]
              description: 用户状态

    ReferralChainResponse:
      type: object
      properties:
        referral_chain:
          type: array
          items:
            type: object
            properties:
              user:
                type: string
                pattern: '^luckee[a-z0-9]{38}$'
                description: 用户地址
              level:
                type: integer
                minimum: 1
                maximum: 3
                description: 推荐层级
              points:
                type: string
                pattern: '^[0-9]+$'
                description: 积分数量
              user_level:
                type: string
                enum: ["Bronze", "Silver", "Gold", "Platinum"]
                description: 用户等级
              referral_count:
                type: integer
                description: 推荐数量
        total_depth:
          type: integer
          description: 总深度
        total_nodes:
          type: integer
          description: 总节点数

    PointsLeaderboardResponse:
      type: object
      properties:
        leaderboard:
          type: array
          items:
            type: object
            properties:
              rank:
                type: integer
                description: 排名
              user:
                type: string
                pattern: '^luckee[a-z0-9]{38}$'
                description: 用户地址
              points:
                type: string
                pattern: '^[0-9]+$'
                description: 积分数量
              user_level:
                type: string
                enum: ["Bronze", "Silver", "Gold", "Platinum"]
                description: 用户等级
              referral_count:
                type: integer
                description: 推荐数量
        total_users:
          type: integer
          description: 总用户数
        user_rank:
          type: integer
          description: 查询用户的排名
          nullable: true

    ConfigResponse:
      type: object
      properties:
        config:
          $ref: '#/components/schemas/ContractConfig'
        admin:
          type: string
          pattern: '^luckee[a-z0-9]{38}$'
          description: 管理员地址
```

### 4. 错误响应规范

```yaml
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: 错误代码
              example: "USER_ALREADY_EXISTS"
            message:
              type: string
              description: 错误消息
              example: "用户已存在"
            details:
              type: object
              description: 错误详情
              properties:
                field:
                  type: string
                  description: 错误字段
                  example: "user"
                value:
                  type: string
                  description: 错误值
                  example: "luckee1invalid..."
                suggestion:
                  type: string
                  description: 修复建议
                  example: "使用有效的用户地址"

    ErrorCodes:
      type: object
      properties:
        USER_ALREADY_EXISTS:
          type: object
          properties:
            code: "USER_ALREADY_EXISTS"
            message: "用户已存在"
            http_status: 400
        INVALID_REFERRER:
          type: object
          properties:
            code: "INVALID_REFERRER"
            message: "无效的推荐人地址"
            http_status: 400
        CIRCULAR_REFERRAL:
          type: object
          properties:
            code: "CIRCULAR_REFERRAL"
            message: "检测到循环推荐"
            http_status: 400
        UNAUTHORIZED:
          type: object
          properties:
            code: "UNAUTHORIZED"
            message: "调用者无权限执行此操作"
            http_status: 401
        USER_NOT_FOUND:
          type: object
          properties:
            code: "USER_NOT_FOUND"
            message: "用户不存在"
            http_status: 404
        INSUFFICIENT_POINTS:
          type: object
          properties:
            code: "INSUFFICIENT_POINTS"
            message: "积分不足"
            http_status: 400
        SYSTEM_PAUSED:
          type: object
          properties:
            code: "SYSTEM_PAUSED"
            message: "系统已暂停"
            http_status: 503
```

## 🔒 数据验证规则

### 1. 地址验证

```yaml
address_validation:
  pattern: '^luckee[a-z0-9]{38}$'
  description: "Luckee地址格式验证"
  examples:
    valid: "luckee1abc123def456ghi789jkl012mno345pqr678stu901vwx234"
    invalid: "cosmos1abc123..." # 错误的地址前缀
    invalid: "luckee1abc" # 地址长度不足
```

### 2. 积分数量验证

```yaml
points_validation:
  pattern: '^[0-9]+$'
  minimum: "1"
  maximum: "1000000000000000000"
  description: "积分数量验证"
  examples:
    valid: "1000000" # 100万积分
    valid: "1" # 最小单位
    invalid: "0" # 不能为0
    invalid: "1000000000000000001" # 超过最大值
    invalid: "1.5" # 不能有小数
    invalid: "-1000000" # 不能为负数
```

### 3. 用户等级验证

```yaml
user_level_validation:
  enum: ["Bronze", "Silver", "Gold", "Platinum"]
  description: "用户等级验证"
  examples:
    valid: "Bronze"
    valid: "Platinum"
    invalid: "Diamond" # 不存在的等级
    invalid: "bronze" # 大小写敏感
```

## 📊 状态码映射

```yaml
status_code_mapping:
  success:
    http_status: 200
    cosmwasm_status: "success"
    description: "操作成功"
  
  bad_request:
    http_status: 400
    cosmwasm_status: "failure"
    description: "请求参数错误"
    error_codes:
      - "USER_ALREADY_EXISTS"
      - "INVALID_REFERRER"
      - "CIRCULAR_REFERRAL"
      - "INSUFFICIENT_POINTS"
      - "INVALID_POINTS"
  
  unauthorized:
    http_status: 401
    cosmwasm_status: "failure"
    description: "权限不足"
    error_codes:
      - "UNAUTHORIZED"
  
  not_found:
    http_status: 404
    cosmwasm_status: "failure"
    description: "资源不存在"
    error_codes:
      - "USER_NOT_FOUND"
  
  service_unavailable:
    http_status: 503
    cosmwasm_status: "failure"
    description: "服务不可用"
    error_codes:
      - "SYSTEM_PAUSED"
```

## 🔄 版本兼容性

```yaml
version_compatibility:
  current_version: "1.0.0"
  supported_versions:
    - "1.0.0"
  
  breaking_changes:
    v1.0.0:
      - "初始版本发布"
      - "基础推荐积分功能"
      - "用户等级系统"
  
  migration_guide:
    initial_deployment:
      - "首次部署无需迁移"
      - "配置推荐规则"
      - "设置权限控制"
```

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-01-XX | 初始接口规范创建 | AI Assistant |

---

**注意**: 本文档是AI之间、系统与系统之间交互的"法律文书"，任何接口变更都必须同步更新本文档，并通知所有相关方。