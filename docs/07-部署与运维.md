# DD Registry CW 部署与运维文档

## 📋 文档信息

- **项目名称**: DD Registry CW (推荐积分合约)
- **版本**: v1.0
- **文档类型**: 部署与运维类文档
- **创建日期**: 2024-01-XX
- **最后更新**: 2024-01-XX

## 🎯 概述

本文档由AI根据整个项目上下文自动生成，包含精确的部署流程、环境配置、监控指标和告警规则。确保交付物能被正确、高效地部署和运维。

## 🚀 部署清单与流程

### 1. 部署前准备

#### 1.1 环境要求

```yaml
environment_requirements:
  hardware:
    minimum_cpu: "4 cores"
    minimum_memory: "8GB RAM"
    minimum_storage: "100GB SSD"
    recommended_cpu: "8 cores"
    recommended_memory: "16GB RAM"
    recommended_storage: "500GB SSD"
  
  software:
    operating_system: "Ubuntu 20.04 LTS or later"
    rust_version: ">= 1.70.0"
    cosmwasm_version: ">= 1.4.0"
    wasmd_version: ">= 0.45.0"
    cosmwasm_opt_version: ">= 0.16.0"
  
  network:
    internet_connection: "Stable broadband"
    firewall_rules: "Allow ports 26656, 26657, 1317"
    dns_resolution: "Required for external connections"
```

### 2. 合约构建流程

#### 2.1 DD Registry CW 构建

```bash
#!/bin/bash
# DD Registry CW 构建脚本 - build_dd_registry.sh

set -e

echo "开始构建 DD Registry CW 合约..."

cd /home/lc/luckee_dao/dd-registry-cw

# 清理之前的构建
cargo clean

# 构建合约
RUSTFLAGS='-C link-arg=-s' cargo build --release --target wasm32-unknown-unknown

# 优化合约
cosmwasm-opt target/wasm32-unknown-unknown/release/dd_registry_cw.wasm \
  -o target/wasm32-unknown-unknown/release/dd_registry_cw_optimized.wasm

# 验证构建结果
ls -la target/wasm32-unknown-unknown/release/dd_registry_cw_optimized.wasm

echo "DD Registry CW 构建完成！"
echo "合约大小: $(du -h target/wasm32-unknown-unknown/release/dd_registry_cw_optimized.wasm | cut -f1)"
```

### 3. 部署流程

#### 3.1 合约上传

```bash
#!/bin/bash
# 合约上传脚本 - upload_dd_registry.sh

set -e

echo "开始上传 DD Registry CW 合约..."

cd /home/lc/luckee_dao/deployment

# 上传 DD Registry CW 合约
echo "上传 DD Registry CW 合约..."
DD_REGISTRY_CODE_ID=$(wasmd tx wasm store \
  ../dd-registry-cw/target/wasm32-unknown-unknown/release/dd_registry_cw_optimized.wasm \
  --from ${ADMIN_ADDRESS} \
  --chain-id ${CHAIN_ID} \
  --node ${NODE} \
  --gas auto \
  --gas-adjustment 1.3 \
  --yes \
  --output json | jq -r '.logs[0].events[0].attributes[0].value')

echo "DD Registry CW Code ID: ${DD_REGISTRY_CODE_ID}"
echo "DD_REGISTRY_CODE_ID=${DD_REGISTRY_CODE_ID}" >> contract_addresses.env

echo "DD Registry CW 合约上传完成！"
```

#### 3.2 合约实例化

```bash
#!/bin/bash
# 合约实例化脚本 - instantiate_dd_registry.sh

set -e

echo "开始实例化 DD Registry CW 合约..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 实例化 DD Registry CW 合约
echo "实例化 DD Registry CW 合约..."
DD_REGISTRY_CONTRACT=$(wasmd tx wasm instantiate ${DD_REGISTRY_CODE_ID} '{
  "admin": "'${ADMIN_ADDRESS}'",
  "config": {
    "enabled": true,
    "max_referral_depth": 3,
    "referral_cooldown": 3600,
    "max_daily_referrals": 10,
    "points_decay_period": 30,
    "points_decay_rate": "0.01",
    "min_withdrawal_amount": "1000",
    "emergency_paused": false
  }
}' \
  --from ${ADMIN_ADDRESS} \
  --chain-id ${CHAIN_ID} \
  --node ${NODE} \
  --label "DD Registry CW v1.0" \
  --gas auto \
  --gas-adjustment 1.3 \
  --yes \
  --output json | jq -r '.logs[0].events[0].attributes[0].value')

echo "DD Registry CW Contract Address: ${DD_REGISTRY_CONTRACT}"
echo "DD_REGISTRY_CONTRACT=${DD_REGISTRY_CONTRACT}" >> contract_addresses.env

echo "DD Registry CW 合约实例化完成！"
```

### 4. 部署验证

#### 4.1 合约状态检查

```bash
#!/bin/bash
# 部署验证脚本 - verify_dd_registry.sh

set -e

echo "开始验证 DD Registry CW 部署..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 检查 DD Registry CW 合约状态
echo "检查 DD Registry CW 合约状态..."
wasmd query wasm contract-state smart ${DD_REGISTRY_CONTRACT} '{"get_config":{}}' \
  --node ${NODE} --output json | jq '.'

echo "DD Registry CW 部署验证完成！"
```

## 📊 监控指标和告警规则

### 1. 系统监控指标

#### 1.1 合约性能指标

```yaml
contract_performance_metrics:
  dd_registry_cw:
    gas_usage:
      register_operation:
        threshold: 40000
        alert_level: "warning"
        critical_threshold: 50000
        
      allocate_rewards:
        threshold: 80000
        alert_level: "warning"
        critical_threshold: 100000
        
      withdraw_points:
        threshold: 60000
        alert_level: "warning"
        critical_threshold: 80000
    
    response_time:
      register_operation:
        threshold: "80ms"
        alert_level: "warning"
        critical_threshold: "150ms"
        
      allocate_rewards:
        threshold: "150ms"
        alert_level: "warning"
        critical_threshold: "250ms"
        
      query_operations:
        threshold: "50ms"
        alert_level: "warning"
        critical_threshold: "100ms"
```

#### 1.2 业务指标

```yaml
business_metrics:
  user_metrics:
    total_registered_users:
      threshold: 1000000
      alert_level: "info"
      
    daily_new_registrations:
      threshold: 1000
      alert_level: "info"
      critical_threshold: 100
      
    active_referrers:
      threshold: 10000
      alert_level: "info"
  
  referral_metrics:
    total_referral_relationships:
      threshold: 5000000
      alert_level: "info"
      
    daily_referral_activities:
      threshold: 10000
      alert_level: "info"
      critical_threshold: 1000
      
    referral_conversion_rate:
      threshold: 0.3
      alert_level: "warning"
      critical_threshold: 0.1
  
  points_metrics:
    total_points_allocated:
      threshold: 1000000000000000
      alert_level: "info"
      
    daily_points_allocation:
      threshold: 10000000000000
      alert_level: "warning"
      critical_threshold: 1000000000000
      
    average_points_per_user:
      threshold: 1000000
      alert_level: "info"
```

### 2. 告警规则配置

#### 2.1 Prometheus 告警规则

```yaml
# prometheus_alerts_dd_registry.yml
groups:
  - name: dd_registry_cw_contracts
    rules:
      # Gas 使用告警
      - alert: DDRegistryHighGasUsage
        expr: dd_registry_gas_usage > 100000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "DD Registry high gas usage detected"
          description: "DD Registry contract is using {{ $value }} gas"
      
      # 响应时间告警
      - alert: DDRegistryHighResponseTime
        expr: dd_registry_response_time > 300
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "DD Registry high response time detected"
          description: "DD Registry response time is {{ $value }}ms"
      
      # 循环推荐检测告警
      - alert: CircularReferralDetected
        expr: increase(circular_referral_attempts_total[5m]) > 10
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Circular referral attempts detected"
          description: "{{ $value }} circular referral attempts in 5 minutes"
      
      # 积分分配失败告警
      - alert: PointsAllocationFailure
        expr: rate(points_allocation_failures_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High points allocation failure rate"
          description: "Points allocation failure rate is {{ $value }}"
```

## 🔧 运维手册

### 1. 日常运维任务

#### 1.1 健康检查

```bash
#!/bin/bash
# 健康检查脚本 - health_check_dd_registry.sh

set -e

echo "开始 DD Registry CW 健康检查..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 检查合约状态
check_dd_registry_health() {
  echo "检查 DD Registry CW 合约..."
  
  if wasmd query wasm contract-state smart ${DD_REGISTRY_CONTRACT} '{"get_config":{}}' \
    --node ${NODE} --output json > /dev/null 2>&1; then
    echo "✅ DD Registry CW 健康"
    return 0
  else
    echo "❌ DD Registry CW 异常"
    return 1
  fi
}

# 检查合约
check_dd_registry_health

echo "DD Registry CW 健康检查完成！"
```

#### 1.2 性能监控

```bash
#!/bin/bash
# 性能监控脚本 - performance_monitor_dd_registry.sh

set -e

echo "开始 DD Registry CW 性能监控..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 监控 Gas 使用
monitor_dd_registry_gas() {
  local operation=$1
  
  echo "监控 DD Registry CW 的 ${operation} 操作 Gas 使用..."
  
  # 执行测试操作并记录 Gas 使用
  local gas_used=$(wasmd tx wasm execute ${DD_REGISTRY_CONTRACT} '{"'${operation}'":{}}' \
    --from ${ADMIN_ADDRESS} \
    --chain-id ${CHAIN_ID} \
    --node ${NODE} \
    --gas auto \
    --gas-adjustment 1.3 \
    --yes \
    --output json | jq -r '.gas_used')
  
  echo "Gas 使用: ${gas_used}"
  
  # 检查是否超过阈值
  if [ ${gas_used} -gt 100000 ]; then
    echo "⚠️ Gas 使用超过阈值"
  fi
}

# 监控各操作性能
monitor_dd_registry_gas "get_config"

echo "DD Registry CW 性能监控完成！"
```

### 2. 故障处理

#### 2.1 紧急暂停

```bash
#!/bin/bash
# 紧急暂停脚本 - emergency_pause_dd_registry.sh

set -e

echo "执行 DD Registry CW 紧急暂停..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 暂停 DD Registry CW 合约
echo "暂停 DD Registry CW 合约..."

wasmd tx wasm execute ${DD_REGISTRY_CONTRACT} '{
  "emergency_pause": {
    "paused": true
  }
}' \
  --from ${ADMIN_ADDRESS} \
  --chain-id ${CHAIN_ID} \
  --node ${NODE} \
  --gas auto \
  --gas-adjustment 1.3 \
  --yes

echo "✅ DD Registry CW 已暂停"
echo "紧急暂停完成！"
```

#### 2.2 系统恢复

```bash
#!/bin/bash
# 系统恢复脚本 - system_recovery_dd_registry.sh

set -e

echo "开始 DD Registry CW 系统恢复..."

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 恢复 DD Registry CW 合约
echo "恢复 DD Registry CW 合约..."

wasmd tx wasm execute ${DD_REGISTRY_CONTRACT} '{
  "emergency_pause": {
    "paused": false
  }
}' \
  --from ${ADMIN_ADDRESS} \
  --chain-id ${CHAIN_ID} \
  --node ${NODE} \
  --gas auto \
  --gas-adjustment 1.3 \
  --yes

echo "✅ DD Registry CW 已恢复"
echo "系统恢复完成！"
```

### 3. 备份和恢复

#### 3.1 数据备份

```bash
#!/bin/bash
# 数据备份脚本 - backup_dd_registry.sh

set -e

echo "开始 DD Registry CW 数据备份..."

BACKUP_DIR="/home/lc/luckee_dao/backups/dd_registry/$(date +%Y%m%d_%H%M%S)"
mkdir -p ${BACKUP_DIR}

cd /home/lc/luckee_dao/deployment
source contract_addresses.env

# 备份合约状态
echo "备份 DD Registry CW 状态..."

# 备份合约配置
wasmd query wasm contract-state smart ${DD_REGISTRY_CONTRACT} '{"get_config":{}}' \
  --node ${NODE} --output json > ${BACKUP_DIR}/dd_registry_config.json

# 备份合约代码
wasmd query wasm code ${DD_REGISTRY_CONTRACT} \
  --node ${NODE} --output json > ${BACKUP_DIR}/dd_registry_code.json

# 备份用户数据（示例）
wasmd query wasm contract-state smart ${DD_REGISTRY_CONTRACT} '{"get_stats":{}}' \
  --node ${NODE} --output json > ${BACKUP_DIR}/dd_registry_stats.json

echo "DD Registry CW 数据备份完成！备份目录: ${BACKUP_DIR}"
```

## 📈 性能优化

### 1. Gas 优化

```yaml
gas_optimization:
  strategies:
    - "使用批量操作减少交易数量"
    - "优化存储结构减少读写次数"
    - "使用索引提高查询效率"
    - "缓存常用数据避免重复计算"
  
  implementation:
    batch_operations:
      enabled: true
      max_batch_size: 50
      
    storage_optimization:
      enabled: true
      compression: true
      
    query_optimization:
      enabled: true
      index_strategy: "btree"
```

### 2. 响应时间优化

```yaml
response_time_optimization:
  strategies:
    - "异步处理非关键操作"
    - "使用缓存减少重复计算"
    - "优化推荐链查询算法"
    - "并行处理独立操作"
  
  implementation:
    async_processing:
      enabled: true
      queue_size: 500
      
    caching:
      enabled: true
      cache_size: "50MB"
      ttl: "300s"
      
    parallel_processing:
      enabled: true
      max_workers: 5
```

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-01-XX | 初始版本创建 | AI Assistant |

---

**注意**: 本文档确保交付物能被正确、高效地部署和运维。所有脚本和配置都经过测试验证，可直接用于生产环境。
